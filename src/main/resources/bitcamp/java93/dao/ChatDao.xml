<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java93.dao.ChatDao">

  <resultMap type="chat" id="chatMap">
    <id column='mno' property='memberno'/>
    <id column="tno" property="trainerno" />
    <result column="date" property="arrivedate" />
    <result column="msg" property="message" />
    <result column="confirm" property="confirm" />
    <result column="unread" property="unread" />
    <result column="name" property="yourName" />
    <result column="timg" property="tPath"/>
    <result column="mimg" property="mPath"/>
    <result column="pm" property="pm"/>
    <result column="time" property="time"/>
    <collection property="noList" ofType="string">
      <result column="mno"/>
    </collection>
    <collection property="tnoList" ofType="string">
      <result column="tno"/>
    </collection>
  </resultMap>
  
  <select id="selectMemberAll" resultMap="chatMap" parameterType="int">
		select 
		c.mno, tno,
		substring_index(group_concat(date_format(date, '%Y-%m-%d') order by date desc), ',', 1)  as date,
		substring_index(group_concat(msg order by date desc), ',', 1) as msg,
		sum(if(confirm=0, if(whosend=c.tno, 1, 0), 0)) as unread,
		date_format(date, '%h:%i') as time,
    date_format(date, '%p') as pm,
		m.name, m.img as timg
		from chat c inner join memb m on c.tno=m.mno
		group by c.mno, c.tno
		having c.mno = #{memberno}
		order by c.date desc;
		
		
  </select>
  
  <select id="memberChatStatus" resultType="int" parameterType="chat">
  	select count(*)
  	from chat
  	where confirm = 0 and mno = #{memberno} and whosend !=#{memberno}
  </select>
  
  <select id="trainerChatStatus" resultType="int" parameterType="chat">
  	select count(*)
  	from chat
  	where confirm = 0 and tno = #{trainerno} and whosend != #{trainerno}
  </select>
  
  <select id="selectTrainerAll" resultMap="chatMap" parameterType="int">
		select 
		c.mno, tno,
		substring_index(group_concat(date_format(date, '%Y-%m-%d') order by date desc), ',', 1)  as date,
		substring_index(group_concat(msg order by date desc), ',', 1) as msg,
		sum(if(confirm=0, if(whosend=c.mno, 1, 0), 0)) as unread,
		date_format(date, '%h:%i') as time,
    date_format(date, '%p') as pm,
		m.name, m.img as timg
		from chat c inner join memb m on c.mno=m.mno
		group by c.mno, c.tno
		having c.tno = #{trainerno}
		
  </select>
  
  <update id="updateRead" parameterType="chat">
      update  chat set confirm = true
        where tno = #{trainerno} and whosend != #{mymno} and mno = #{memberno}
  </update>
  
</mapper>
