<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
  <link rel='stylesheet' href='../css/bombee.css'>
  <link rel='stylesheet' href='../css/chat.css'>
  <script src="../node_modules/jquery/dist/jquery.min.js"></script>
  <script src="../node_modules/handlebars/dist/handlebars.min.js"></script>
</head>
<body>
<div class='chat-container'>

  <div class='chat-body'>
    <div class='chat-header'>
      <span class="fa fa-times close-btn" aria-hidden="true"></span>
      <span class='chat-list'>목록</span>
    </div>
    <div class='chat-content' id='chat-container'>

    </div>
  </div>
</div>

<script id="chat-template" type="text/x-handlebars-template">
  {{#each data}}
  <div class='chat-line'>
    <div><img src='../image/2.jpg' id='chat-user'/></div>
    <dl>
       {{#youAndMe this}}
      <dt id='youAndMe' value='{{memberno}}'>{{yourName}}</dt>
       {{else}}
       <dt id='youAndMe' value='{{trainerno}}'>{{yourName}}</dt>
       {{/youAndMe}}
      <dd>{{message}}</dd>
    </dl>
  </div>
  {{/each}}
</script>



<script type="text/javascript">
var no = -1
var tno = -1
var yourName
var yourNo
var chatLine
var myNo
var membertype

/* var server = location.host + '/upload/' */
var server = location.host + '/image/2.jpg';
console.log(server)

$.getJSON('/auth/userinfo.json', function(result) {
	 console.log(result.data.name)
	if (result.status != 'fail'){
		membertype = result.data.membertype
		if(result.data.membertype == 1) {
			no = result.data.no
			myNo = no
		}
		if(result.data.membertype == 2) {
			tno = result.data.no
			myNo = tno
		}
        	
			console.log(no)
			console.log(tno)
			if (tno != -1)
				getChat(tno, '/chat/trainerList.json')
			else if (no != -1)
				getChat(no, '/chat/memberList.json')
	}
  /*  else if(result.status == 'fail')
	   location.href='../auth/login.html'  */
	})
	
function getChat(no, json) {
	$.getJSON(json, {no}, function(result) {
		console.log(result)
		yourName = result.data.you
		
		console.log(yourNo)
		  // 템플릿 소스를 가지고 템플릿을 처리할 함수를 얻는다.
		  var templateFn = Handlebars.compile($('#chat-template').text())
		  var generatedHTML = templateFn(result) // 템플릿 함수에 데이터를 넣고 HTML을 생성한다.
		  var container = $('#chat-container')
		  var html = container.html()
		  container.html(html + generatedHTML) // 새 tr 태그들로 설정한다.
		  chatDetailBtn()
		 })
}


Handlebars.registerHelper('youAndMe', function(chatInfo ,options) {
	console.log(chatInfo)
	
	if (no == -1) {
      console.log('강사로그인')
      if (tno == chatInfo.trainerno){
        yourNo = chatInfo.memberno
        return options.fn(this);
      }
    }else if (tno == -1) {
      console.log('멤버로그인')
      if (no == chatInfo.memberno) {
        yourNo = chatInfo.trainerno
      }
    }
      
      return options.inverse(this);
  });
  
  function chatDetailBtn() {
	  chatLine = $('.chat-line')
	  chatLine.click(function () {
		console.log($(this).children('dl').children('dt').attr('value'))
		location.href = 'http://192.168.0.13:8888/detail-chat.html?myNo=' + myNo + '&yourNo='
				+ $(this).children('dl').children('dt').attr('value')+'&yourName='
				+$(this).children('dl').children('dt').text()+'&membertype='+membertype +
				'&imagePath='+ server;
	  })
  }


</script>
</body>
</html>
